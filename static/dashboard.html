<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Dashboard | Compra+</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,sans-serif}
    body{background:var(--app-bg);color:var(--app-text);min-height:100vh;overflow-x:hidden}

    :root{
      --primary:#1e40af; --primary-light:#3b82f6; --primary-dark:#1e3a8a;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --info:#0ea5e9;

      --gray-50:#f8fafc; --gray-100:#f1f5f9; --gray-200:#e2e8f0; --gray-300:#cbd5e1;
      --gray-400:#94a3b8; --gray-500:#64748b; --gray-600:#475569; --gray-700:#334155; --gray-800:#1e293b;

      --radius-sm:10px; --radius-md:14px; --radius-lg:18px;
      --shadow-sm:0 1px 3px rgba(0,0,0,.08);
      --shadow-md:0 8px 20px rgba(0,0,0,.08);
      --shadow-lg:0 20px 50px rgba(0,0,0,.15);

      --transition:all .25s ease;
      --sidebar-w:260px;

      --app-bg:#f8fafc; --app-card:#ffffff; --app-card-2:#f8fafc;
      --app-text:#1e293b; --app-muted:#64748b; --app-border:#e2e8f0;
      --app-input:#ffffff; --app-input-border:#e2e8f0;
      --app-header:#ffffff; --app-profile:#f1f5f9; --app-profile-hover:#e2e8f0;
      --app-table-head:#ffffff;
    }

    /* Tipografia fluida */
    :root{
      --fs-page-h1: clamp(1.25rem, 2.8vw, 1.7rem);
      --fs-kpi: clamp(1.55rem, 4.2vw, 2rem);
      --fs-title: clamp(1.05rem, 2.2vw, 1.25rem);
      --content-pad: clamp(14px, 2.6vw, 20px);
    }

    .content{padding: var(--content-pad);}
    .page-head h1{font-size: var(--fs-page-h1);}
    .kpi .num{font-size: var(--fs-kpi);}
    .title-wrap h2{font-size: var(--fs-title);}

    /* Melhor comportamento em telas com notch */
    .header{
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-left: calc(18px + env(safe-area-inset-left));
      padding-right: calc(18px + env(safe-area-inset-right));
    }

    /* Evita "pulos" de layout em overflow */
    .twrap{ -webkit-overflow-scrolling: touch; }

    html[data-theme="dark"]{
      --app-bg:#0b1220; --app-card:#0f172a; --app-card-2:#0b1220;
      --app-text:#e5e7eb; --app-muted:#94a3b8; --app-border:#1f2a3a;
      --app-input:#0b1220; --app-input-border:#1f2a3a;
      --app-header:#0f172a; --app-profile:#111c30; --app-profile-hover:#172746;
      --app-table-head:#0b1220;
    }

    .dashboard{display:flex;min-height:100vh}
    .main{flex:1;min-width:0;margin-left:var(--sidebar-w);transition:var(--transition)}

    .sidebar{
      position:fixed;top:0;left:0;width:var(--sidebar-w);height:100vh;
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
      color:#fff;padding:18px 12px;box-shadow:5px 0 18px rgba(0,0,0,.12);
      z-index:1200;transition:transform .28s ease;
    }
    .brand{
      padding:10px 12px 18px;border-bottom:1px solid rgba(255,255,255,.12);
      margin-bottom:12px;display:flex;align-items:center;gap:10px;
    }
    .brand i{font-size:1.35rem}
    .brand h2{font-size:1.5rem;letter-spacing:.2px}
    .brand h2 span{color:#60a5fa}

    .nav{padding:8px 6px}
    .nav a{
      display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--radius-md);
      color:rgba(255,255,255,.86);text-decoration:none;transition:var(--transition);margin-bottom:6px;
    }
    .nav a i{width:20px;text-align:center}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff;transform:translateX(4px)}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1100}
    .overlay.show{display:block}

    .header{
      position:sticky;top:0;z-index:900;background:var(--app-header);
      box-shadow:var(--shadow-sm);min-height:72px;padding:14px 18px;
      display:flex;align-items:center;gap:14px;justify-content:space-between;border-bottom:1px solid var(--app-border);
    }
    .header-left{display:flex;align-items:center;gap:12px;min-width:0}
    .menu-btn{
      display:none;border:none;background:var(--gray-100);color:var(--primary);
      width:44px;height:44px;border-radius:12px;cursor:pointer;transition:var(--transition);flex:0 0 auto;
    }
    html[data-theme="dark"] .menu-btn{background:#111c30;color:#93c5fd}
    html[data-theme="dark"] .menu-btn:hover{background:#172746}
    .menu-btn:hover{background:var(--gray-200)}
    .title-wrap h2{font-size:1.25rem;color:var(--primary);line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title-wrap p{font-size:.9rem;color:var(--app-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .header-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap;position:relative}
    .profile{
      display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--app-profile);
      border-radius:999px;cursor:pointer;transition:var(--transition);
      min-width:180px;max-width:340px;border:1px solid var(--app-border);
    }
    .profile:hover{background:var(--app-profile-hover)}
    .avatar{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;flex:0 0 auto;
    }
    .pinfo h4{font-size:.92rem;color:var(--app-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
    .pinfo p{font-size:.8rem;color:var(--app-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:11px 16px;border:none;border-radius:var(--radius-lg);cursor:pointer;font-weight:800;
      transition:var(--transition);text-decoration:none;white-space:nowrap;
    }
    .btn:active{transform:scale(.99)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;box-shadow:0 8px 18px rgba(59,130,246,.18)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(59,130,246,.25)}
    .btn-secondary{background:var(--gray-100);color:var(--gray-700);border:2px solid var(--gray-200)}
    html[data-theme="dark"] .btn-secondary{background:#111c30;color:#e5e7eb;border-color:var(--app-border)}
    html[data-theme="dark"] .btn-secondary:hover{background:#172746}
    .btn-info{background:linear-gradient(135deg,var(--info),#22d3ee);color:#fff}
    .btn-success{background:linear-gradient(135deg,var(--success),#34d399);color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#f87171);color:#fff}
    .btn-sm{padding:8px 12px;border-radius:14px;font-size:.9rem}

    .logout{
      border:none;background:var(--danger);color:#fff;padding:10px 14px;border-radius:999px;cursor:pointer;
      font-weight:800;display:flex;align-items:center;gap:8px;transition:var(--transition);white-space:nowrap;
    }
    .logout:hover{background:#dc2626;transform:translateY(-1px);box-shadow:var(--shadow-md)}

    .content{padding:20px}
    .page-head{display:flex;align-items:flex-end;justify-content:space-between;gap:14px;margin:14px 0 18px;flex-wrap:wrap}
    .page-head h1{font-size:1.7rem;color:var(--primary);line-height:1.1}
    .page-head p{color:var(--app-muted);margin-top:8px}

    .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      margin-top:14px;
    }
    .card{
      background:var(--app-card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-md);
      border:1px solid var(--app-border);
      overflow:hidden;
    }
    .card-head{
      padding:16px;border-bottom:1px solid var(--app-border);
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      background:var(--app-card);
    }
    .card-head h3{display:flex;align-items:center;gap:10px;color:var(--app-text);font-size:1.15rem}
    .card-body{padding:16px}
    .kpi{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .kpi .num{font-size:2rem;font-weight:900;letter-spacing:.2px}
    .kpi .lbl{color:var(--app-muted);font-weight:800;margin-top:6px}
    .kpi .ico{
      width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;
      background:var(--app-card-2);border:1px solid var(--app-border);
      color:var(--primary);font-size:1.1rem;
    }
    .hint{
      margin-top:12px;color:var(--app-muted);font-weight:700;line-height:1.35
    }

    .split{
      display:grid;
      grid-template-columns:1.25fr .75fr;
      gap:12px;
      margin-top:12px;
    }

    .twrap{
      margin:16px;border:1px solid var(--app-border);border-radius:16px;overflow:auto;background:var(--app-card);
      max-height:420px;
    }
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:12px 10px;border-bottom:1px solid var(--app-border);text-align:left;vertical-align:middle}
    th{color:var(--app-muted);font-size:.9rem;font-weight:900;background:var(--app-table-head);position:sticky;top:0}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;font-weight:900;font-size:.85rem;
      border:1px solid var(--app-border);background:var(--app-card-2);white-space:nowrap;
    }
    .st-ok{background:#d1fae5;color:#065f46;border-color:#a7f3d0}
    .st-warn{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .st-bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    html[data-theme="dark"] .st-ok{background:rgba(16,185,129,.14);color:#a7f3d0;border-color:rgba(16,185,129,.22)}
    html[data-theme="dark"] .st-warn{background:rgba(245,158,11,.14);color:#fde68a;border-color:rgba(245,158,11,.22)}
    html[data-theme="dark"] .st-bad{background:rgba(239,68,68,.14);color:#fecaca;border-color:rgba(239,68,68,.22)}

    .toast{
      position:fixed;top:18px;right:18px;z-index:3000;
      background:var(--app-card);border-radius:16px;box-shadow:var(--shadow-lg);
      border-left:5px solid var(--primary);padding:12px 14px;
      display:flex;gap:10px;align-items:center;
      max-width:min(420px, calc(100vw - 36px));
      transform:translateX(140%);transition:transform .25s ease;color:var(--app-text);
    }
    .toast.show{transform:translateX(0)}
    .toast i{color:var(--primary)}

    /* Estilos para notificações - REMOVIDO
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      border: 2px solid var(--app-header);
      animation: pulse 1.5s infinite;
    } */

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Painel de Notificações - REMOVIDO
    .notification-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 420px;
      max-width: calc(100vw - 40px);
      max-height: 70vh;
      background: var(--app-card);
      border: 1px solid var(--app-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 9999;
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: slideDown 0.3s ease;
    }

    .notification-header {
      padding: 16px;
      border-bottom: 1px solid var(--app-border);
      background: var(--app-card-2);
      flex-shrink: 0;
    }

    .notification-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .notification-header p {
      color: var(--app-muted);
      font-size: 0.9rem;
    }

    .notification-content {
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--app-muted);
    }

    .notification-empty i {
      font-size: 2rem;
      opacity: 0.5;
      margin-bottom: 12px;
      display: block;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--app-border);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
    }

    .notification-item:hover {
      background: var(--app-card-2);
    }

    .notification-item.unread {
      background: rgba(59, 130, 246, 0.08);
      border-left: 4px solid var(--primary);
    }

    .notification-item .title {
      font-weight: 900;
      color: var(--app-text);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .notification-item .time {
      color: var(--app-muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .notification-item .desc {
      color: var(--app-muted);
      font-size: 0.9rem;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* Indicador de não lido
    .unread-dot {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
    } */

    /* Modal de Análise */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-overlay.show {
      display: flex;
      animation: modalFadeIn 0.3s ease;
    }
    
    .modal {
      width: 100%;
      max-width: 980px;
      max-height: 90vh;
      background: var(--app-card);
      border: 1px solid var(--app-border);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .modal-head {
      padding: 20px;
      border-bottom: 1px solid var(--app-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      background: var(--app-card);
    }
    
    .modal-head h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-size: 1.2rem;
      margin: 0;
    }
    
    .close {
      border: none;
      background: transparent;
      color: var(--app-muted);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .close:hover {
      background: var(--app-card-2);
      color: var(--danger);
    }
    
    .modal-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }
    
    .modal-actions {
      padding: 20px;
      border-top: 1px solid var(--app-border);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      background: var(--app-card-2);
      flex-shrink: 0;
    }
    
    .hr {
      height: 1px;
      background: var(--app-border);
      margin: 16px 0;
      border: none;
    }
    
    /* Estilos específicos para o conteúdo do modal */
    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .pedido-info h4 {
      color: var(--primary);
      font-size: 1.3rem;
      margin-bottom: 4px;
    }
    
    .pedido-info p {
      color: var(--app-muted);
      font-weight: 700;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .info-box {
      background: var(--app-card-2);
      border: 1px solid var(--app-border);
      border-radius: 12px;
      padding: 16px;
    }
    
    .info-box h5 {
      color: var(--app-text);
      font-weight: 900;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }
    
    .info-box p {
      color: var(--app-muted);
      margin-bottom: 4px;
      word-break: break-word;
    }
    
    .info-box .main-text {
      color: var(--app-text);
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .items-table-container {
      overflow-x: auto;
      margin-bottom: 20px;
      border: 1px solid var(--app-border);
      border-radius: 12px;
    }
    
    .items-table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
    }
    
    .items-table th {
      background: var(--app-table-head);
      padding: 14px 12px;
      color: var(--app-muted);
      font-size: 0.9rem;
      font-weight: 900;
      text-align: left;
      border-bottom: 1px solid var(--app-border);
    }
    
    .items-table td {
      padding: 12px;
      border-bottom: 1px solid var(--app-border);
      vertical-align: middle;
    }
    
    .items-table tfoot td {
      padding: 16px 12px;
      font-weight: 900;
      color: var(--primary);
      background: var(--app-card-2);
    }
    
    .items-table .total-cell {
      font-size: 1.1rem;
    }
    
    .historico-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--app-border);
      border-radius: 12px;
      padding: 12px;
      background: var(--app-card-2);
    }
    
    .historico-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--app-border);
    }
    
    .historico-item:last-child {
      border-bottom: none;
    }
    
    .historico-action {
      font-weight: 700;
      color: var(--app-text);
      margin-bottom: 2px;
    }
    
    .historico-details {
      font-size: 0.85rem;
      color: var(--app-muted);
    }
    
    .loading-container {
      text-align: center;
      padding: 60px 20px;
      color: var(--app-muted);
    }
    
    .loading-spinner {
      font-size: 2.5rem;
      margin-bottom: 16px;
      color: var(--primary);
    }
    
    .error-container {
      text-align: center;
      padding: 60px 20px;
      color: var(--app-muted);
    }
    
    .error-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
      color: var(--danger);
    }

    /* Responsividade */
    @media (max-width: 992px){
      .menu-btn{display:inline-flex;align-items:center;justify-content:center}
      .main{margin-left:0}
      .sidebar{transform:translateX(-105%)}
      .sidebar.show{transform:translateX(0)}
      .grid{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
      table{min-width:780px}
      /* Painel de Notificações REMOVIDO
      .notification-panel {
        width: 380px;
        right: 10px;
        max-width: calc(100vw - 20px);
      } */
      
      .modal {
        max-height: 95vh;
      }
      
      .modal-body {
        max-height: calc(95vh - 140px);
      }
    }

    @media (max-width: 768px) {
      /* Painel de Notificações REMOVIDO
      .notification-panel {
        top: 70px;
        right: 10px;
        left: 10px;
        width: calc(100vw - 20px);
        max-width: calc(100vw - 20px);
      }
      
      .notification-content {
        max-height: 60vh;
      } */
      
      .modal-overlay {
        padding: 10px;
      }
      
      .modal {
        max-height: 98vh;
        border-radius: 16px;
      }
      
      .modal-head {
        padding: 16px;
      }
      
      .modal-body {
        padding: 16px;
        max-height: calc(98vh - 140px);
      }
      
      .modal-actions {
        padding: 16px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .pedido-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 640px){
      .header{flex-wrap:wrap;align-items:flex-start}
      .header-right{width:100%;justify-content:space-between}
      .profile{flex:1;min-width:0}
      .btn{width:100%}
      table{min-width:720px}
      /* Painel de Notificações REMOVIDO
      .notification-panel {
        top: 65px;
        max-height: 80vh;
      }
      
      .notification-item {
        padding: 10px 12px;
      }
      
      .notification-item .title {
        font-size: 0.9rem;
      }
      
      .notification-item .desc {
        font-size: 0.85rem;
      } */
      
      .modal-head h3 {
        font-size: 1.1rem;
      }
      
      .pedido-info h4 {
        font-size: 1.2rem;
      }
      
      .modal-actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .modal-actions > div {
        width: 100%;
      }
      
      .modal-actions .btn {
        flex: 1;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      /* Painel de Notificações REMOVIDO
      .notification-panel {
        max-height: 80vh;
      } */
      
      .modal-overlay {
        padding: 5px;
      }
      
      .modal {
        max-height: 99vh;
        border-radius: 12px;
      }
      
      .modal-head {
        padding: 14px;
      }
      
      .modal-body {
        padding: 14px;
        max-height: calc(99vh - 140px);
      }
      
      .close {
        width: 40px;
        height: 40px;
      }
      
      .items-table {
        min-width: 500px;
      }
    }
  
    @media (max-width: 420px){
      .header-right{gap:10px}
      .logout{width:100%;justify-content:center}
      .btn-secondary{width:100%}
    }

  </style>
</head>

<body>
  <div class="overlay" id="overlay" aria-hidden="true"></div>

  <!-- Modal de Análise de Pedido -->
  <div class="modal-overlay" id="analiseModal" aria-hidden="true">
    <div class="modal">
      <div class="modal-head">
        <h3><i class="fas fa-clipboard-check"></i> Análise de Pedido</h3>
        <button class="close" id="closeAnaliseModal" aria-label="Fechar"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="analiseContent">
        <!-- Conteúdo será carregado dinamicamente -->
      </div>
      <div class="modal-actions">
        <div style="color:var(--app-muted);font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:8px">
          <i class="fas fa-info-circle"></i> Analise o pedido e decida
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-secondary" id="cancelAnaliseBtn">Fechar</button>
          <button class="btn btn-danger" id="reprovarBtn"><i class="fas fa-times"></i> Reprovar</button>
          <button class="btn btn-success" id="aprovarBtn"><i class="fas fa-check"></i> Aprovar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Painel de Notificações REMOVIDO
  <div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
      <h3><i class="fas fa-bell"></i> Notificações</h3>
      <p>Pedidos enviados para análise</p>
    </div>
    <div class="notification-content" id="notificationContent">
      Conteúdo das notificações será carregado aqui
    </div>
  </div> -->

  <div class="dashboard">
    <aside class="sidebar" id="sidebar" aria-label="Menu lateral">
      <div class="brand">
        <i class="fas fa-shopping-cart"></i>
        <h2>Compra<span>+</span></h2>
      </div>

      <nav class="nav">
        <!-- Menu será gerado dinamicamente pelo JavaScript -->
      </nav>
    </aside>

    <main class="main">
      <header class="header">
        <div class="header-left">
          <button class="menu-btn" id="menuBtn" aria-label="Abrir menu" aria-controls="sidebar" aria-expanded="false">
            <i class="fas fa-bars"></i>
          </button>

          <div class="title-wrap">
            <h2 id="pageTitle">Dashboard</h2>
            <p id="subTitle">Visão geral em tempo real do Compra+</p>
          </div>
        </div>

        <div class="header-right">
          <div class="profile" id="userProfile" title="Perfil do usuário">
            <div class="avatar" id="userAvatar">A</div>
            <div class="pinfo">
              <h4 id="userName">Carregando...</h4>
              <p id="userRole">—</p>
            </div>
          </div>

          <button class="btn btn-secondary" id="themeToggleBtn" title="Alternar tema">
            <i class="fas fa-moon" id="themeIcon"></i>
            <span id="themeText">Escuro</span>
          </button>

          <!-- Botão de Notificações REMOVIDO
          <button class="btn btn-secondary" id="notificationBtn" title="Notificações" style="position:relative;display:none">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge">0</span>
          </button> -->

          <button class="logout" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>
      </header>

      <section class="content">
        <div class="page-head">
          <div>
            <h1 id="mainTitle">Painel geral</h1>
            <p id="rtInfo">Carregando dados do servidor...</p>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-secondary" id="refreshBtn"><i class="fas fa-rotate"></i> Atualizar</button>
            <a class="btn btn-primary" href="pedidos.html" id="goToPedidosBtn" style="display:none"><i class="fas fa-bolt"></i> Ir para Pedidos</a>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="card-head">
              <h3><i class="fas fa-gavel"></i> Licitações</h3>
              <span class="pill st-ok" id="licStatus"><i class="fas fa-signal"></i> Online</span>
            </div>
            <div class="card-body">
              <div class="kpi">
                <div>
                  <div class="num" id="kpiLics">—</div>
                  <div class="lbl">Total cadastradas</div>
                </div>
                <div class="ico"><i class="fas fa-scale-balanced"></i></div>
              </div>
              <div class="hint" id="licHint">Carregando…</div>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3><i class="fas fa-clipboard-list"></i> Pedidos</h3>
              <span class="pill st-ok" id="pedStatus"><i class="fas fa-signal"></i> Online</span>
            </div>
            <div class="card-body">
              <div class="kpi">
                <div>
                  <div class="num" id="kpiPeds">—</div>
                  <div class="lbl">Total registrados</div>
                </div>
                <div class="ico"><i class="fas fa-receipt"></i></div>
              </div>
              <div class="hint" id="pedHint">Carregando…</div>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3><i class="fas fa-truck"></i> Fornecedores</h3>
              <span class="pill st-ok" id="fornStatus"><i class="fas fa-signal"></i> Online</span>
            </div>
            <div class="card-body">
              <div class="kpi">
                <div>
                  <div class="num" id="kpiForns">—</div>
                  <div class="lbl">Total cadastrados</div>
                </div>
                <div class="ico"><i class="fas fa-building"></i></div>
              </div>
              <div class="hint" id="fornHint">Carregando…</div>
            </div>
          </div>
        </div>

        <div class="split">
          <div class="card">
            <div class="card-head">
              <h3><i class="fas fa-clock-rotate-left"></i> Últimos pedidos</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <a class="btn btn-secondary btn-sm" href="pedidos.html" id="verTodosPedidosBtn" style="display:none"><i class="fas fa-eye"></i> Ver todos</a>
              </div>
            </div>
            <div class="twrap">
              <table>
                <thead>
                  <tr>
                    <th>Nº</th>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="lastOrdersBody"></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3><i class="fas fa-bullhorn"></i> Licitações recentes</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <a class="btn btn-secondary btn-sm" href="licitacoes.html" id="verLicitacoesBtn" style="display:none"><i class="fas fa-eye"></i> Abrir</a>
              </div>
            </div>
            <div class="card-body">
              <div id="recentLics" style="display:flex;flex-direction:column;gap:10px"></div>
              <div class="hint" style="margin-top:12px">
                Realtime ativo (SSE). Mudou algo em outra tela? aqui atualiza sozinho.
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <script>
    // =========================
    // Configurações globais
    // =========================
    const API = {
      stats: '/api/stats',
      pull: '/api/sync/pull',
      authCheck: '/api/auth/check',
      events: '/api/events',
      notifications: '/api/notifications',
      markRead: '/api/notifications/mark-read',
      analisarPedido: '/api/pedidos/analisar'
    };

    
    // =========================
    // Rotas (funciona em file:// e no servidor)
    // =========================
    const IS_FILE = window.location.protocol === 'file:';
    function pageHref(fileName){
      // relativo funciona em ambos; em servidor vira /arquivo automaticamente se estiver na raiz
      return fileName;
    }
let CURRENT_USER = {
      id: null,
      name: 'Usuário',
      role: 'Consulta',
      allowed_pages: []
    };

    // =========================
    // Helpers
    // =========================
    function toast(msg, type = 'info'){
      const el = document.createElement('div');
      el.className = 'toast';
      const icon = type === 'success' ? 'fa-check-circle' : 
                   type === 'error' ? 'fa-exclamation-circle' : 
                   'fa-info-circle';
      const color = type === 'success' ? 'var(--success)' : 
                    type === 'error' ? 'var(--danger)' : 
                    'var(--primary)';
      el.innerHTML = `<i class="fas ${icon}"></i><div style="font-weight:700">${msg}</div>`;
      el.style.borderLeftColor = color;
      el.querySelector('i').style.color = color;
      document.body.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => { 
        el.classList.remove('show'); 
        setTimeout(() => el.remove(), 220); 
      }, 3000);
    }

    function money(v){ 
      const num = Number(v);
      return Number.isFinite(num) ? num.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : 'R$ 0,00';
    }

    function statusPill(status){
      const s = (status||'').toLowerCase();
      const map = {
        rascunho: {cls:'st-warn', icon:'pen', label:'Rascunho'},
        enviado: {cls:'st-warn', icon:'paper-plane', label:'Enviado'},
        aprovado: {cls:'st-ok', icon:'check-circle', label:'Aprovado'},
        reprovado: {cls:'st-bad', icon:'times-circle', label:'Reprovado'},
        aberta: {cls:'st-ok', icon:'check-circle', label:'Aberta'},
        em_analise: {cls:'st-warn', icon:'clock', label:'Em análise'},
        finalizada: {cls:'st-bad', icon:'ban', label:'Finalizada'},
      };
      const it = map[s] || {cls:'st-warn', icon:'circle-question', label: (status||'—')};
      return `<span class="pill ${it.cls}"><i class="fas fa-${it.icon}"></i> ${it.label}</span>`;
    }

    function getToken(){
      return localStorage.getItem('access_token') || 
             localStorage.getItem('compraPlus_access_token') || 
             localStorage.getItem('compraPlus_token_v1') || 
             '';
    }

    async function apiGet(url){
      const token = getToken();
      const headers = { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      };
      if(token) headers['Authorization'] = `Bearer ${token}`;
      
      try {
        const res = await fetch(url, { headers });
        
        if(!res.ok) {
          if (res.status === 404) {
            return null;
          }
          
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        }
        const data = await res.json();
        return data;
      } catch(error) {
        console.error('Erro na requisição GET:', error);
        throw error;
      }
    }

    async function apiPost(url, payload){
      const token = getToken();
      const headers = { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      };
      if(token) headers['Authorization'] = `Bearer ${token}`;

      try {
        const res = await fetch(url, { 
          method: 'POST', 
          headers, 
          body: JSON.stringify(payload) 
        });
        
        if(!res.ok) {
          const errorText = await res.text();
          const data = await res.json().catch(() => ({}));
          throw new Error(data?.message || `Erro HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        return data;
      } catch(error) {
        console.error('Erro na requisição POST:', error);
        throw error;
      }
    }

    // =========================
    // Theme
    // =========================
    const html = document.documentElement;
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    function applyTheme(theme){
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      if(theme === 'dark'){ 
        themeIcon.className='fas fa-sun'; 
        themeText.textContent='Claro'; 
      } else { 
        themeIcon.className='fas fa-moon'; 
        themeText.textContent='Escuro'; 
      }
    }
    
    function initTheme(){ 
      applyTheme(localStorage.getItem('theme') || 'light'); 
    }
    
    themeToggleBtn.addEventListener('click', ()=>{
      const current = html.getAttribute('data-theme') || 'light';
      applyTheme(current === 'light' ? 'dark' : 'light');
      toast(`Tema ${html.getAttribute('data-theme') === 'dark' ? 'escuro' : 'claro'} aplicado`);
    });

    // =========================
    // Sidebar mobile
    // =========================
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menuBtn');

    function openSidebar(){
      sidebar.classList.add('show');
      overlay.classList.add('show');
      menuBtn.setAttribute('aria-expanded','true');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSidebar(){
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      menuBtn.setAttribute('aria-expanded','false');
      document.body.style.overflow = '';
    }
    
    menuBtn.addEventListener('click', ()=> sidebar.classList.contains('show') ? closeSidebar() : openSidebar());
    overlay.addEventListener('click', closeSidebar);

    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSidebar(); });

    // =========================
    // Menu dinâmico baseado no role
    // =========================
    function generateMenu(allowedPages) {
      const nav = document.querySelector('.nav');
      if (!nav) return;
      
      nav.innerHTML = '';
      
      const menuItems = {
        dashboard: { icon: 'fa-tachometer-alt', label: 'Dashboard', href: 'dashboard.html' },
        pedidos: { icon: 'fa-clipboard-list', label: 'Pedidos', href: 'pedidos.html' },
        licitacoes: { icon: 'fa-gavel', label: 'Licitações', href: 'licitacoes.html' },
        fornecedores: { icon: 'fa-truck', label: 'Fornecedores', href: 'fornecedores.html' },
        relatorios: { icon: 'fa-chart-bar', label: 'Relatórios', href: 'relatorios.html' },
        configuracoes: { icon: 'fa-cog', label: 'Configurações', href: 'configuracoes.html' },
        usuarios: { icon: 'fa-users', label: 'Usuários', href: 'usuarios.html' }
      };
      
      // Sempre adiciona dashboard
      const dashboard = menuItems.dashboard;
      const path = window.location.pathname || '';
      const file = path.split('/').pop();
      const isDashboardPage = (file === '' || file === 'dashboard.html' || file === 'index.html');
      
      const dashboardLink = document.createElement('a');
      dashboardLink.href = dashboard.href;
      dashboardLink.innerHTML = `<i class="fas ${dashboard.icon}"></i><span>${dashboard.label}</span>`;
      if (isDashboardPage) dashboardLink.classList.add('active');
      dashboardLink.addEventListener('click', ()=>{ if (window.matchMedia('(max-width: 992px)').matches) closeSidebar(); });
      nav.appendChild(dashboardLink);
      
      // Adiciona outras páginas permitidas
      for (const page of allowedPages) {
        if (page === 'dashboard') continue;
        
        const menuItem = menuItems[page];
        if (menuItem) {
          const link = document.createElement('a');
          link.href = menuItem.href;
          link.innerHTML = `<i class="fas ${menuItem.icon}"></i><span>${menuItem.label}</span>`;
          
          // Marca como ativa se estiver na página atual
          const currentPage = window.location.pathname.split('/').pop() || 'dashboard.html';
          if (menuItem.href.includes(currentPage)) {
            link.classList.add('active');
          }
          
          link.addEventListener('click', ()=>{ if (window.matchMedia('(max-width: 992px)').matches) closeSidebar(); });
          nav.appendChild(link);
        }
      }
    }

    // =========================
    // Auth user profile
    // =========================
    async function loadUser(){
      const nameEl = document.getElementById('userName');
      const roleEl = document.getElementById('userRole');
      const avEl = document.getElementById('userAvatar');
      const subTitle = document.getElementById('subTitle');
      const goToPedidosBtn = document.getElementById('goToPedidosBtn');
      const verTodosPedidosBtn = document.getElementById('verTodosPedidosBtn');
      const verLicitacoesBtn = document.getElementById('verLicitacoesBtn');

      try{
        const data = await apiGet(API.authCheck);
        
        if(data?.authenticated && data.user){
          CURRENT_USER = {
            id: data.user.id,
            name: data.user.name || 'Usuário',
            role: data.user.role || 'Consulta',
            allowed_pages: data.user.allowed_pages || []
          };
          
          nameEl.textContent = CURRENT_USER.name;
          roleEl.textContent = 'Perfil: ' + CURRENT_USER.role;
          avEl.textContent = String((CURRENT_USER.name || 'U').trim().charAt(0)).toUpperCase();
          subTitle.textContent = 'Bem-vindo! Dados do servidor carregados.';
          
          // Gerar menu dinâmico
          generateMenu(CURRENT_USER.allowed_pages);
          
          // Mostrar/ocultar botões baseado no role
          const userRole = CURRENT_USER.role;
          
          // Botão "Ir para Pedidos" (Admin, Gerente e Comprador)
          if (['Administrador', 'Gerente', 'Comprador'].includes(userRole)) {
            goToPedidosBtn.style.display = 'inline-flex';
            verTodosPedidosBtn.style.display = 'inline-flex';
          }
          
          // Botão "Ver Licitações" (todos exceto Consulta)
          if (userRole !== 'Consulta') {
            verLicitacoesBtn.style.display = 'inline-flex';
          }
          
        } else {
          // Usuário não autenticado
          nameEl.textContent = 'Administrador';
          roleEl.textContent = 'Não autenticado';
          avEl.textContent = 'A';
          subTitle.textContent = 'Faça login para acessar os dados do sistema.';
          goToPedidosBtn.style.display = 'none';
          verTodosPedidosBtn.style.display = 'none';
          verLicitacoesBtn.style.display = 'none';
          
          // Menu padrão
          generateMenu(['dashboard']);
        }
      } catch(e){
        nameEl.textContent = 'Administrador';
        roleEl.textContent = 'Sem token / sessão expirada';
        avEl.textContent = 'A';
        subTitle.textContent = 'Conectando ao servidor...';
        
        // Menu padrão
        generateMenu(['dashboard']);
      }
    }

    // =========================
    // Data load
    // =========================
    function setOnline(id, ok){
      const el = document.getElementById(id);
      if(!el) return;
      el.className = 'pill ' + (ok ? 'st-ok' : 'st-bad');
      el.innerHTML = ok
        ? '<i class="fas fa-signal"></i> Online'
        : '<i class="fas fa-triangle-exclamation"></i> Offline';
    }

    async function loadStats(){
      try{
        const data = await apiGet(API.stats);
        const s = data?.stats || {};
        document.getElementById('kpiLics').textContent = (s.licitacoes ?? '—');
        document.getElementById('kpiPeds').textContent = (s.pedidos ?? '—');
        document.getElementById('kpiForns').textContent = (s.fornecedores ?? '—');

        document.getElementById('licHint').textContent = 'Total de licitações no KV Store (sync).';
        document.getElementById('pedHint').textContent = 'Total de pedidos no KV Store (sync).';
        document.getElementById('fornHint').textContent = 'Total de fornecedores no KV Store (sync).';

        setOnline('licStatus', true);
        setOnline('pedStatus', true);
        setOnline('fornStatus', true);
      }catch(err){
        document.getElementById('licHint').textContent = 'Falha ao buscar /api/stats';
        document.getElementById('pedHint').textContent = 'Falha ao buscar /api/stats';
        document.getElementById('fornHint').textContent = 'Falha ao buscar /api/stats';
        setOnline('licStatus', false);
        setOnline('pedStatus', false);
        setOnline('fornStatus', false);
      }
    }

    function renderLastOrders(pedidos){
      const body = document.getElementById('lastOrdersBody');
      body.innerHTML = '';
      const arr = Array.isArray(pedidos) ? pedidos.slice() : [];
      arr.sort((a,b)=> (b.id||0) - (a.id||0));
      const top = arr.slice(0, 10);

      if(top.length === 0){
        body.innerHTML = `<tr><td colspan="4" style="padding:18px;color:var(--app-muted)">
          <i class="fas fa-inbox"></i> Sem pedidos no momento.
        </td></tr>`;
        return;
      }

      top.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:900">${p.numero || ('PED-' + p.id)}</td>
          <td>${p.data || '-'}</td>
          <td>${statusPill(p.status)}</td>
          <td style="font-weight:900">${money(p.total)}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderRecentLics(licitacoes){
      const wrap = document.getElementById('recentLics');
      wrap.innerHTML = '';
      const arr = Array.isArray(licitacoes) ? licitacoes.slice() : [];
      arr.sort((a,b)=> (b.id||0) - (a.id||0));
      const top = arr.slice(0, 6);

      if(top.length === 0){
        wrap.innerHTML = `<div style="color:var(--app-muted);font-weight:800">
          <i class="fas fa-inbox"></i> Sem licitações.
        </div>`;
        return;
      }

      top.forEach(l=>{
        const box = document.createElement('div');
        box.style.border = '1px solid var(--app-border)';
        box.style.background = 'var(--app-card-2)';
        box.style.borderRadius = '16px';
        box.style.padding = '12px';
        box.innerHTML = `
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
            <div style="min-width:0">
              <div style="font-weight:900">${l.numero || ('LIC-' + l.id)}</div>
              <div style="color:var(--app-muted);font-weight:700;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                ${l.descricao || '—'}
              </div>
              <div style="color:var(--app-muted);font-weight:700;margin-top:6px;font-size:.92rem">
                Vigência: ${l.inicio || '-'} <span style="opacity:.7">→</span> ${l.fim || '-'}
              </div>
            </div>
            <div>${statusPill(l.status)}</div>
          </div>
        `;
        wrap.appendChild(box);
      });
    }

    async function loadLists(){
      try{
        const data = await apiGet(API.pull);
        const d = data?.data || {};
        renderLastOrders(d.compraPlusPedidos_v1 || []);
        renderRecentLics(d.compraPlusLicitacoes_v1 || []);
      }catch(err){
        renderLastOrders([]);
        renderRecentLics([]);
        toast('Falha ao buscar listas do servidor', 'error');
      }
    }

    async function refreshAll(silent=false){
      if(!silent) toast('Atualizando dados...');
      await loadStats();
      await loadLists();
    }

    // =========================
    // Realtime SSE
    // =========================
    function startRealtime(){
      let es;
      try{
        const token = getToken();
        const url = token ? (API.events + '?token=' + encodeURIComponent(token)) : API.events;
        es = new EventSource(url);
      }catch(e){
        return;
      }

      es.addEventListener('hello', ()=>{
        document.getElementById('rtInfo').textContent = 'Realtime ativo (SSE). Mudanças em outra tela atualizam aqui.';
      });

      es.addEventListener('data_updated', async (evt)=>{
        try{
          await refreshAll(true);
          toast('Atualização recebida');
        }catch(e){
          await refreshAll(true);
        }
      });

      es.onerror = ()=>{
        document.getElementById('rtInfo').textContent = 'Realtime instável (SSE). Tentando reconectar...';
      };
    }

    // =========================
    // Logout
    // =========================
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      if(confirm('Deseja realmente sair? (isso limpa o token local)')){
        localStorage.removeItem('compraPlus_token_v1');
        localStorage.removeItem('compraPlus_access_token');
        localStorage.removeItem('access_token');
        toast('Saindo do sistema...', 'info');
        setTimeout(() => {
          window.location.href = (window.location.protocol === 'file:') ? 'index.html' : '/';
        }, 500);
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', ()=>refreshAll(false));

    // =========================
    // Boot
    // =========================
    document.addEventListener('DOMContentLoaded', async ()=>{
      initTheme();
      await loadUser();
      await refreshAll(true);
      startRealtime();
    });
    
  </script>
</body>
</html>